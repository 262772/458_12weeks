<!DOCTYPE html>
<html>
<head>
    <title>Create3 Control Panel</title>
</head>
<body>
    <h1 id="panelTitle">Create3 Control Panel</h1>
    <img src="https://i.ytimg.com/vi/YjcS6NAGPIA/maxresdefault.jpg" alt="Control Panel" width="500" height="300">
    <br>
    <input type="text" id="robotName" placeholder="Enter robot name">
    <input type="button" value="Connect" id="connectBtn">
    <h2 id='isConnected'>Disconnected</h2>
    <div>
        <input type="button" value="Left" id="btnLeft">
        <input type="button" value="Forward" id="btnForward">
        <input type="button" value="Right" id="btnRight">
    </div>
    <p id='X'>X: 0.00</p>
    <p id='Y'>Y: 0.00</p>
    <p id='Z'>Yaw: 0.00°</p>
    <p>Battery Voltage: <strong id="battVoltage">0</strong> %</p>
    <h3>IR Sensor Readings</h3>
    <p id="irReadings">
        Sensor 1: <span id="sensor1">0</span>,
        Sensor 2: <span id="sensor2">0</span>, 
        Sensor 3: <span id="sensor3">0</span>, 
        Sensor 4: <span id="sensor4">0</span>, 
        Sensor 5: <span id="sensor5">0</span>, 
        Sensor 6: <span id="sensor6">0</span>, 
        Sensor 7: <span id="sensor7">0</span>
    </p>

</body>
</html>

<style>
    body {
        background: linear-gradient(135deg, #e455dd, #5eea23);
        color: #ffffff;
        font-family: 'Times New Roman', Times, serif;
        text-align: center;
        padding: 20px;
    }
    h1 {
        font-size: 2em;
    }
    img {
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    input[type="text"], input[type="button"] {
        padding: 10px;
        border: none;
        border-radius: 5px;
        margin: 10px;
    }
    input[type="button"] {
        background-color: #ffffff;
        color: #000000;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    input[type="button"]:hover {
        background-color: #f78ff0;
    }
    h2 {
        margin-top: 20px;
    }
    p {
        font-size: 1.2em;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/roslibjs/1.1.0/roslib.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<canvas id="irChart" width="400" height="200"></canvas>

<script>

    console.clear();
    console.log("Hello World");

    const ip = '192.168.8.104';
    const port = '9012';
    let ros;
    let robName = 'juliet';
    let cmdVel;

// Set up the IR sensor chart on a polar grid
let irChart = new Chart(document.getElementById('irChart'), {
    type: 'polarArea',
    data: {
        labels: ['Sensor 1', 'Sensor 2', 'Sensor 3', 'Sensor 4', 'Sensor 5', 'Sensor 6', 'Sensor 7'],
        datasets: [{
            label: 'Distance (m)',
            data: [1, 1.2, 1.5, 2, 1.5, 1.2, 1], // Example distance values for each sensor
            backgroundColor: [
                'rgba(255, 99, 132, 0.5)',
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
            ],
            borderWidth: 1
        }]
    },
    options: {
        scales: {
            r: {
                beginAtZero: true,
                max: 10, // Adjust this based on the expected max distance of the IR sensor
                ticks: {
                    display: false // Hide ticks (numbers around the chart)
                },
                grid: {
                    display: true // Hide the grid lines
                }
            }
        },
        rotation: -Math.PI / 2 - (Math.PI / 7) * 3, // Rotate so sensor 4 is at the top
        circumference: Math.PI, // Limit the chart to half the circle
        plugins: {
            legend: {
                display: false // Optional: hides the legend if you don't want it
            }
        },
    }
});



    const robotName = document.getElementById('robotName');
    robotName.addEventListener('input', function() {
        const name = this.value || 'Create3';
        document.getElementById('panelTitle').innerText = name + ' Control Panel';
    });

    const conBtn = document.getElementById('connectBtn');
    conBtn.addEventListener('click', function() {
        ros = new ROSLIB.Ros({ url: `ws://${ip}:${port}` });

        ros.on('connection', function() {
            document.getElementById('isConnected').innerHTML = "Connected";
            document.getElementById('isConnected').style.color = '#5eea23';

            robName = robotName.value || robName;

            console.log('Connected to ROS!');

            const battTopic = new ROSLIB.Topic({
                ros: ros,
                name: `/${robName}/battery_state`,
                messageType: 'sensor_msgs/BatteryState'
            });

            battTopic.subscribe(function(message) {
                document.getElementById('battVoltage').innerText = (message.percentage * 100).toFixed(1);
            });

            cmdVel = new ROSLIB.Topic({
                ros : ros,
                name : `/${robName}/cmd_vel`,
                messageType : 'geometry_msgs/Twist'
            });

            const odomTopic = new ROSLIB.Topic({
                ros: ros,
                name: `/${robName}/odom`,
                messageType: 'nav_msgs/Odometry'
            });

            odomTopic.subscribe(function(message) {
                const posX = message.pose.pose.position.x.toFixed(2);
                const posY = message.pose.pose.position.y.toFixed(2);
                const { x, y, z, w } = message.pose.pose.orientation;
                const yaw = Math.atan2(2.0 * (w * z + x * y), 1.0 - 2.0 * (y * y + z * z)) * (180 / Math.PI);

                document.getElementById('X').innerText = 'X: ' + posX;
                document.getElementById('Y').innerText = 'Y: ' + posY;
                document.getElementById('Z').innerText = 'Yaw: ' + yaw.toFixed(2) + '°';
            });

            // Subscribe to IR sensors topic
            const irSensorsTopic = new ROSLIB.Topic({
                ros: ros,
                name: `/${robName}/ir_intensity`,
                messageType: 'irobot_create_msgs/IrIntensityVector'
            });

            irSensorsTopic.subscribe(function(message) {
                if (message.readings && message.readings.length > 0) {
                    let sensorDistances = message.readings.map(reading => reading.value).slice(0, 7);
                    irChart.data.datasets[0].data = sensorDistances;
                    irChart.update();
                // Update raw sensor readings
                for (let i = 0; i < sensorDistances.length; i++) {
                    document.getElementById(`sensor${i + 1}`).innerText = sensorDistances[i].toFixed(2);
                }
                    console.log(sensorDistances);
                } else {
                    console.log("No IR sensor data available");
                }
            });
        });
        

        ros.on('error', function(error) {
            console.log('Connection error:', error);
        });

        ros.on('close', function() {
            document.getElementById('isConnected').innerHTML = "Disconnected";
            document.getElementById('isConnected').style.color = '#ff0000';
        });
    });

    const btnLeft = document.getElementById('btnLeft');
    btnLeft.addEventListener('click', function() {
        var twist = new ROSLIB.Message({
            linear: { x: 0, y: 0, z: 0 },
            angular: { x: 0, y: 0, z: 0.5 }
        });
        cmdVel.publish(twist);
    });

    const btnForward = document.getElementById('btnForward');
    btnForward.addEventListener('click', function() {
        var twist = new ROSLIB.Message({
            linear: { x: 0.2, y: 0, z: 0 },
            angular: { x: 0, y: 0, z: 0 }
        });
        cmdVel.publish(twist);
    });

    const btnRight = document.getElementById('btnRight');
    btnRight.addEventListener('click', function() {
        var twist = new ROSLIB.Message({
            linear: { x: 0, y: 0, z: 0 },
            angular: { x: 0, y: 0, z: -0.5 }
        });
        cmdVel.publish(twist);
    });

</script>
</html>